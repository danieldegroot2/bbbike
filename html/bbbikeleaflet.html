<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"> <!-- -*-html-*- -->
<html>
 <head>
 <title>BBBike &amp; Leaflet</title>
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <style>
  body {
    padding: 0;
    margin: 0;
  }
  html, body, #map {
    height: 100%;
  }
 </style>

 <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />

 <!-- Leaflet -->
 <link rel="stylesheet" href="http://bbbike.de/leaflet/dist/leaflet.css" />
 <!--[if lte IE 8]><link rel="stylesheet" href="http://bbbike.de/leaflet/dist/leaflet.ie.css" /><![endif]-->
 <script src="http://bbbike.de/leaflet/dist/leaflet.js"></script>
 <script>
  var initialRouteGeojson = null;
  //--- INSERT GEOJSON HERE ---

  var thisURL = location.href;
  var lang = "de";
  if (thisURL.match(/bbbikeleaflet\.en\./)) {
    lang = "en";
    thisURL = thisURL.replace(/bbbikeleaflet\.en\./, "bbbikeleaflet.");
  }
  var useOldURLLayout = thisURL.match(/(cgi\/bbbikeleaflet|bbbike\/html\/bbbikeleaflet)/);
  var bbbikeRoot, cgiURL, bbbikeImagesRoot;
  if (useOldURLLayout) {
    bbbikeRoot = thisURL.replace(/\/(cgi|html)\/bbbikeleaflet\.(html$|cgi.*)/, "");
    bbbikeImagesRoot = bbbikeRoot + "/images";
    cgiURL     = bbbikeRoot + "/cgi/bbbike.cgi";
  } else {
    bbbikeRoot = thisURL.replace(/\/(cgi-bin|BBBike\/html)\/bbbikeleaflet\.(html$|cgi.*)/, "");
    bbbikeImagesRoot = bbbikeRoot + "/BBBike/images";
    cgiURL     = bbbikeRoot + "/cgi-bin/bbbike.cgi";
  }

  var msg = {"en":{"Kartendaten":"Map data",
		   "Qualit\u00e4t":"Smoothness"
                  }};
  function M(string) {
    if (msg[lang] && msg[lang][string]) {
      return msg[lang][string];
    } else {
      return string;
    }
  }  	    

  var routeLayer;
  var searchState = "start";
  var startLatLng;
  var map;

  var startIconClass = L.Icon.extend({
    iconUrl: bbbikeImagesRoot + "/flag2_bl_centered.png",
    shadowUrl: bbbikeImagesRoot + "/flag_shadow.png",
    iconSize: new L.Point(32,32),
    shadowSize: new L.Point(45,24),
    iconAnchor: new L.Point(16,16)
  });
  var startIcon = new startIconClass();
  var goalIconClass = L.Icon.extend({
    iconUrl: bbbikeImagesRoot + "/flag_ziel_centered.png",
    shadowUrl: bbbikeImagesRoot + "/flag_shadow.png",
    iconSize: new L.Point(32,32),
    shadowSize: new L.Point(45,24),
    iconAnchor: new L.Point(16,16)
  });
  var goalIcon = new goalIconClass();

  var loadingIconClass = L.Icon.extend({
    iconUrl: bbbikeImagesRoot + "/loading.gif",
    shadowUrl: bbbikeImagesRoot + "/px_1t.gif",
    iconSize: new L.Point(16,16),
    shadowSize: new L.Point(1,1),
    iconAnchor: new L.Point(0,0)
  });
  var loadingIcon = new loadingIconClass();

  var startMarker, goalMarker, loadingMarker;

  function do_leaflet() {
    var bbbikeOrgMapnikGermanUrl = 'http://tile.bbbike.org/osm/mapnik-german/{z}/{x}/{y}.png',
        bbbikeAttribution = M("Kartendaten") + ' \u00a9 2012 <a href="http://bbbike.de">Slaven ReziÄ‡</a>',
        bbbikeTileLayer = new L.TileLayer(bbbikeOrgMapnikGermanUrl, {maxZoom: 18, attribution: bbbikeAttribution});

    var bbbikeOrgSmoothnessUrl = 'http://tile.bbbike.org/osm/bbbike-smoothness/{z}/{x}/{y}.png',
        bbbikeSmoothnessTileLayer = new L.TileLayer(bbbikeOrgSmoothnessUrl, {maxZoom: 18, attribution: bbbikeAttribution});

    var osmMapnikUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
	osmAttribution = M("Kartendaten") + ' \u00a9 2012 <a href="http://www.openstreetmap.org/">OpenStreetMap</a> Contributors',
	osmTileLayer = new L.TileLayer(osmMapnikUrl, {maxZoom: 18, attribution: osmAttribution});
    
    // initialize the map on the "map" div
    map = new L.Map('map',
		    {
		     zoomAnimation:false, fadeAnimation:false, // animations may be super-slow
		     doubleClickZoom:false, // used for setting start/goal, see below for click/dblclick event
		     layers: [bbbikeTileLayer]
		    }
		   );

    var baseMaps = { "BBBike":bbbikeTileLayer, "OSM":osmTileLayer };
    var overlayMaps = {};
    overlayMaps[M("Qualit\u00e4t")] = bbbikeSmoothnessTileLayer;

    var layersControl = new L.Control.Layers(baseMaps, overlayMaps);
    map.addControl(layersControl);

    map.addLayer(bbbikeTileLayer);

    routeLayer = new L.GeoJSON();
    map.addLayer(routeLayer);
    layersControl.addOverlay(routeLayer, "Route");

    map.on(//'click', //XXX has bugs, may fire on simple zooming
           'dblclick', function(e) {
      if (searchState == "start") {
        startLatLng = e.latlng;

        if (goalMarker) {
	  map.removeLayer(goalMarker);
        }
        set_start_marker(startLatLng);

        searchState = 'goal';
      } else if (searchState == "goal") {
        set_goal_marker(e.latlng);

        searchRoute(startLatLng, e.latlng);
        searchState = 'start';
      }
    });

    if (initialRouteGeojson) {
      showRoute(initialRouteGeojson);
      map.setView(L.GeoJSON.coordsToLatLng(initialRouteGeojson.geometry.coordinates[0]), 13);
    } else {
      map.setView(new L.LatLng(52.516224, 13.377463), 13); // Brandenburger Tor
    }
  }

  function getSearchCoordParams(startPoint, goalPoint) {
    return "startc_wgs84=" + startPoint.lng + "," + startPoint.lat + ";zielc_wgs84=" + goalPoint.lng + "," + goalPoint.lat;
  }

//XXX do not hardcode!
  var commonSearchParams = ";pref_seen=1;pref_speed=20;pref_cat=;pref_quality=;pref_green=;scope=;referer=bbbikeleaflet;output_as=geojson";

  function searchRoute(startPoint, goalPoint) {
    var searchCoordParams = getSearchCoordParams(startPoint, goalPoint);
    var requestLine = cgiURL + "?" + searchCoordParams + commonSearchParams;
    var routeRequest = new XMLHttpRequest();
    routeRequest.open("GET", requestLine, true);
    set_loading_marker(goalPoint);
    routeRequest.onreadystatechange = function() {
        showRouteResult(routeRequest);
    };
    routeRequest.send(null);
  }

  function showRouteResult(request) {
    if (request.readyState == 4) {
      if (request.status != 200) {
        alert("Error calculating route: " + request.statusText  + " (status=" + request.status + ")");
      } else {
        var geojson;
        var json = "geojson = " + request.responseText;
        eval(json);
        showRoute(geojson);
      }
      map.removeLayer(loadingMarker);
    }
  }

  function showRoute(geojson) {
    routeLayer.clearLayers();
    routeLayer.addGeoJSON(geojson);
    var coordinates_length = geojson.geometry.coordinates.length;
    if (coordinates_length) {
      set_start_marker(L.GeoJSON.coordsToLatLng(geojson.geometry.coordinates[0]));
      set_goal_marker (L.GeoJSON.coordsToLatLng(geojson.geometry.coordinates[coordinates_length-1]));
    }
  }

  function set_start_marker(latLng) {
    if (!startMarker) {
      startMarker = new L.Marker(latLng, {icon:startIcon});
    } else {
      startMarker.setLatLng(latLng);
    }
    map.addLayer(startMarker);
  }

  function set_goal_marker(latLng) {
    if (!goalMarker) {
      goalMarker = new L.Marker(latLng, {icon:goalIcon});
    } else {
      goalMarker.setLatLng(latLng);
    }
    map.addLayer(goalMarker);
  }

  function set_loading_marker(latLng) {
    if (!loadingMarker) {
      loadingMarker = new L.Marker(latLng, {icon:loadingIcon});
    } else {
      loadingMarker.setLatLng(latLng);
    }
    map.addLayer(loadingMarker);
  }

 </script>

</head>
<body onLoad="do_leaflet();">
 <div id="map"></div>
</body>
</html>
